<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commercial Property Listings – Singapore</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; color: #222; }
    .header {
      padding: 1rem 1.5rem;
      background: #1a1a2e;
      color: #eee;
    }
    .header h1 { margin: 0; font-size: 1.25rem; font-weight: 600; }
    .controls {
      display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;
      padding: 0.75rem 1.5rem; background: #fff; border-bottom: 1px solid #e0e0e0;
    }
    .controls label { font-size: 0.875rem; color: #555; }
    .controls select { padding: 0.35rem 0.6rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.875rem; }
    .layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      min-height: calc(100vh - 140px);
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    #map {
      height: 100%;
      min-height: 400px;
    }
    .list-panel {
      background: #fff;
      overflow-y: auto;
      max-height: calc(100vh - 140px);
    }
    .list-panel h2 { margin: 0; padding: 1rem 1.5rem; font-size: 1rem; font-weight: 600; border-bottom: 1px solid #eee; }
    .card {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.15s;
    }
    .card:hover { background: #f8f9fa; }
    .card.active { background: #e8f4fd; border-left: 3px solid #1a1a2e; }
    .card-address { font-weight: 600; margin-bottom: 0.35rem; }
    .card-address a { color: #1a1a2e; text-decoration: none; }
    .card-address a:hover { text-decoration: underline; }
    .card-meta { font-size: 0.8125rem; color: #555; margin-top: 0.25rem; }
    .card-comments { font-size: 0.8125rem; color: #666; margin-top: 0.5rem; max-height: 2.5em; overflow: hidden; text-overflow: ellipsis; }
    .card-thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 4px; float: right; margin-left: 0.5rem; }
    .popup-content { min-width: 220px; max-width: 320px; }
    .popup-content img { width: 100%; max-height: 160px; object-fit: cover; border-radius: 4px; margin-bottom: 0.5rem; }
    .popup-address { font-weight: 600; margin-bottom: 0.5rem; }
    .popup-meta { font-size: 0.875rem; color: #555; margin: 0.25rem 0; }
    .popup-comments { font-size: 0.8125rem; color: #666; margin-top: 0.5rem; }
    .popup-link { display: inline-block; margin-top: 0.5rem; padding: 0.35rem 0.75rem; background: #1a1a2e; color: #fff; text-decoration: none; border-radius: 4px; font-size: 0.875rem; }
    .popup-link:hover { background: #2d2d44; }
    .upload-section {
      padding: 0.75rem 1.5rem; background: #fff; border-bottom: 1px solid #e0e0e0;
    }
    .upload-section .upload-input {
      width: 100%; max-width: 560px; padding: 0.5rem 0.6rem; border: 1px solid #ccc; border-radius: 4px; font-size: 0.875rem;
    }
    .upload-section .upload-input::placeholder { color: #999; }
    .upload-hint { color: #999; font-size: 0.8125rem; margin-top: 0.35rem; }
    .upload-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-top: 0.5rem; }
    .upload-actions button, .upload-actions .file-label {
      padding: 0.35rem 0.75rem; border-radius: 4px; font-size: 0.875rem; cursor: pointer;
    }
    .upload-actions .btn-load { background: #1a1a2e; color: #fff; border: none; }
    .upload-actions .btn-load:hover { background: #2d2d44; }
    .upload-actions .btn-restore, .upload-actions .btn-download { background: #f0f0f0; color: #222; border: 1px solid #ccc; }
    .upload-actions .btn-restore:hover, .upload-actions .btn-download:hover { background: #e5e5e5; }
    .upload-actions .file-label { display: inline-block; background: #f0f0f0; border: 1px solid #ccc; }
    .upload-actions input[type="file"] { display: none; }
    .card-wrap { position: relative; }
    .card-remove {
      position: absolute; top: 0.5rem; right: 0.5rem; padding: 0.2rem 0.4rem; font-size: 0.75rem;
      background: #e0e0e0; color: #555; border: none; border-radius: 4px; cursor: pointer;
    }
    .card-remove:hover { background: #d0d0d0; color: #222; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Commercial Property Listings – Singapore</h1>
  </div>
  <div class="upload-section">
    <input type="text" id="csv-url" class="upload-input" placeholder="Paste your Google Sheet CSV link here (File → Share → Publish to web → CSV), or upload a CSV file below.">
    <div class="upload-hint">CSV columns: address, url, sizeSqFt, pricePerMonth, psf, mrt, status, comments, lat, lng</div>
    <div class="upload-actions">
      <button type="button" id="load-csv-btn" class="btn-load">Load</button>
      <label class="file-label"><input type="file" id="csv-file" accept=".csv"> Upload CSV</label>
      <button type="button" id="restore-removed-btn" class="btn-restore">Restore removed</button>
      <button type="button" id="download-json-btn" class="btn-download">Download current listings (JSON)</button>
    </div>
  </div>
  <div class="controls">
    <label>Status:</label>
    <select id="filter-status">
      <option value="">All</option>
      <option value="Viewed">Viewed</option>
      <option value="Unviewed">Unviewed</option>
    </select>
    <label>Sort:</label>
    <select id="sort-by">
      <option value="price-asc">Price (low to high)</option>
      <option value="price-desc">Price (high to low)</option>
      <option value="psf-asc">PSF (low to high)</option>
      <option value="psf-desc">PSF (high to low)</option>
      <option value="address">Address (A–Z)</option>
    </select>
  </div>
  <div class="layout">
    <div id="map"></div>
    <div class="list-panel">
      <h2>Listings</h2>
      <div id="list"></div>
    </div>
  </div>

  <script type="application/json" id="listings-data">[{"address":"881 North Bridge Road","url":"https://www.commercialguru.com.sg/listing/for-rent-southbank-23626192#","sizeSqFt":1012,"pricePerMonth":4280,"psf":4.23,"mrt":"Lavender - 5mins walk","status":"Unviewed","comments":"","lat":1.3521,"lng":103.8198},{"address":"882 North Bridge Road","url":"https://www.commercialguru.com.sg/listing/for-rent-southbank-23315055#","sizeSqFt":1184,"pricePerMonth":5328,"psf":4.5,"mrt":"Lavender - 5mins walk","status":"Unviewed","comments":"","lat":1.3531,"lng":103.8198},{"address":"Boat Quay / Raffles Place / Marina","url":"https://www.commercialguru.com.sg/listing/for-rent-value-rental-from-4-50psf-sheltered-to-mrt-raffles-area-60153294#","sizeSqFt":1722,"pricePerMonth":7749,"psf":4.5,"mrt":"Downtown - 3mins walk","status":"Unviewed","comments":"","lat":1.3541,"lng":103.8198},{"address":"881 North Bridge Road","url":"https://www.commercialguru.com.sg/listing/for-rent-southbank-60203765#","sizeSqFt":1012,"pricePerMonth":4290,"psf":4.24,"mrt":"Lavender - 5mins walk","status":"Unviewed","comments":"","lat":1.3551,"lng":103.8198},{"address":"CES Centre 171 Chin Swee Road","url":"https://www.commercialguru.com.sg/listing/for-rent-ces-centre-25471283","sizeSqFt":1432,"pricePerMonth":8303,"psf":5.8,"mrt":"Chinatown - 8mins walk","status":"Unviewed","comments":"","lat":1.3561,"lng":103.8198},{"address":"Amoy Street","url":"https://www.commercialguru.com.sg/listing/for-rent-amoy-street-60193336#","sizeSqFt":1533,"pricePerMonth":9800,"psf":6.39,"mrt":"Telok Ayer - 2mins walk","status":"Unviewed","comments":"","lat":1.3571,"lng":103.8198},{"address":"72 Bendemeer Road","url":"https://www.commercialguru.com.sg/listing/for-rent-newly-renovated-3-mins-walk-to-boon-keng-mrt-500000046#location-section","sizeSqFt":1405,"pricePerMonth":7687,"psf":5.47,"mrt":"Bendemeer - 7mins walk","status":"Unviewed","comments":"","lat":1.3581,"lng":103.8198},{"address":"CT Hub","url":"https://www.commercialguru.com.sg/listing/for-rent-ct-hub-60194084","sizeSqFt":1824,"pricePerMonth":7800,"psf":4.28,"mrt":"Bendemeer - 3mins walk","status":"Viewed","comments":"Big space reno cost will be higher(repainting/flooring works. This unit have an odd wall design near the CEO office.","lat":1.3591,"lng":103.8198},{"address":"CT Hub 2 #10-88","url":"https://www.commercialguru.com.sg/listing/for-rent-ct-hub-2-60228055","sizeSqFt":1700,"pricePerMonth":6550,"psf":3.85,"mrt":"Bendemeer - 3mins walk","status":"Viewed","comments":"Smaller space horizontally as compared to our current unit. But bigger space vertically. 2 floors. Too many glass doors and lack of natural light.","lat":1.3601,"lng":103.8198},{"address":"CT Hub 2","url":"https://www.commercialguru.com.sg/listing/for-rent-ct-hub-2-25120849","sizeSqFt":1928,"pricePerMonth":8500,"psf":4.41,"mrt":"Bendemeer - 3mins walk","status":"Viewed","comments":"Too big. We co sharing with the owner, although owner will do a partisian wall between us","lat":1.3611,"lng":103.8198},{"address":"CT Hub 2 #07-62","url":"https://www.commercialguru.com.sg/listing/for-rent-ct-hub-2-60037679","sizeSqFt":2000,"pricePerMonth":9000,"psf":4.5,"mrt":"Bendemeer - 3mins walk","status":"Viewed","comments":"Big space/well furnished/min. reno needed. Offered 45k take over, move in 10th May, Tenant asking 50k take over instead","lat":1.3621,"lng":103.8198}]</script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    (function () {
      var SINGAPORE = [1.3521, 103.8198];
      var map = L.map('map').setView(SINGAPORE, 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>' }).addTo(map);

      var markers = [];
      var listings = [];
      var HIDDEN_KEY = 'property-listings-hidden';
      var SINGAPORE_LAT = 1.3521, SINGAPORE_LNG = 103.8198;

      function listingId(listing) {
        return (listing.address || '') + '|' + (listing.url || '');
      }
      function getHiddenSet() {
        try {
          var raw = localStorage.getItem(HIDDEN_KEY);
          return raw ? new Set(JSON.parse(raw)) : new Set();
        } catch (e) { return new Set(); }
      }
      function setHidden(id) {
        var set = getHiddenSet();
        set.add(id);
        localStorage.setItem(HIDDEN_KEY, JSON.stringify([].slice.call(set)));
      }
      function clearHidden() {
        localStorage.removeItem(HIDDEN_KEY);
      }
      function visibleListings() {
        var hidden = getHiddenSet();
        return listings.filter(function (l) { return !hidden.has(listingId(l)); });
      }

      function loadData() {
        return fetch('listings.json')
          .then(function (r) { return r.ok ? r.json() : Promise.reject(); })
          .catch(function () {
            var el = document.getElementById('listings-data');
            return el ? JSON.parse(el.textContent) : [];
          });
      }

      function parseCsvLine(line) {
        var out = [], inQuote = false, cur = '';
        for (var i = 0; i < line.length; i++) {
          var c = line[i];
          if (c === '"') { inQuote = !inQuote; continue; }
          if (!inQuote && c === ',') { out.push(cur.trim()); cur = ''; continue; }
          cur += c;
        }
        out.push(cur.trim());
        return out;
      }
      function parseCsv(text) {
        var lines = text.trim().split(/\r?\n/);
        if (lines.length < 2) return [];
        var headerVals = parseCsvLine(lines[0]);
        var headers = headerVals.map(function (h) { return h.trim().toLowerCase().replace(/\s+/g, ''); });
        var rows = [];
        for (var i = 1; i < lines.length; i++) {
          var vals = parseCsvLine(lines[i]);
          var row = {};
          headers.forEach(function (h, j) {
            var v = vals[j] !== undefined ? vals[j] : '';
            if (h === 'address') row.address = v;
            else if (h === 'url') row.url = v;
            else if (h === 'sizesqft') row.sizeSqFt = parseInt(v, 10) || 0;
            else if (h === 'pricepermonth') row.pricePerMonth = parseFloat(v) || 0;
            else if (h === 'psf') row.psf = parseFloat(v) || 0;
            else if (h === 'mrt') row.mrt = v;
            else if (h === 'status') row.status = v;
            else if (h === 'comments') row.comments = v;
            else if (h === 'lat') row.lat = parseFloat(v) || SINGAPORE_LAT;
            else if (h === 'lng') row.lng = parseFloat(v) || SINGAPORE_LNG;
            else if (h === 'imageurl') row.imageUrl = v;
          });
          if (!row.lat) row.lat = SINGAPORE_LAT;
          if (!row.lng) row.lng = SINGAPORE_LNG;
          rows.push(row);
        }
        return rows;
      }
      function loadFromUrl(url) {
        var proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
        return fetch(proxy).then(function (r) { return r.text(); }).then(function (text) {
          var rows = parseCsv(text);
          listings = listings.concat(rows);
          syncMarkersAndList();
        });
      }
      function loadFromFile(file) {
        var reader = new FileReader();
        reader.onload = function () {
          var rows = parseCsv(reader.result);
          listings = listings.concat(rows);
          syncMarkersAndList();
        };
        reader.readAsText(file);
      }

      function formatPrice(n) {
        return '$' + Number(n).toLocaleString('en-SG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function popupHtml(listing) {
        var parts = [];
        if (listing.imageUrl) {
          parts.push('<img src="' + escapeHtml(listing.imageUrl) + '" alt="">');
        }
        parts.push('<div class="popup-address">' + escapeHtml(listing.address) + '</div>');
        parts.push('<div class="popup-meta">' + listing.sizeSqFt + ' sq ft &middot; ' + formatPrice(listing.pricePerMonth) + '/mth &middot; $' + listing.psf + ' PSF</div>');
        parts.push('<div class="popup-meta">' + escapeHtml(listing.mrt) + ' &middot; ' + escapeHtml(listing.status) + '</div>');
        if (listing.comments) {
          parts.push('<div class="popup-comments">' + escapeHtml(listing.comments) + '</div>');
        }
        parts.push('<a class="popup-link" href="' + escapeHtml(listing.url) + '" target="_blank" rel="noopener">View listing</a>');
        return '<div class="popup-content">' + parts.join('') + '</div>';
      }

      function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function renderCard(listing, index) {
        var thumb = listing.imageUrl
          ? '<img class="card-thumb" src="' + escapeHtml(listing.imageUrl) + '" alt="">'
          : '';
        var id = escapeHtml(listingId(listing));
        return (
          '<div class="card-wrap"><button type="button" class="card-remove" data-listing-id="' + id + '" title="Remove from list">Remove</button>' +
          '<div class="card" data-index="' + index + '">' +
            thumb +
            '<div class="card-address"><a href="' + escapeHtml(listing.url) + '" target="_blank" rel="noopener" onclick="event.stopPropagation()">' + escapeHtml(listing.address) + '</a></div>' +
            '<div class="card-meta">' + listing.sizeSqFt + ' sq ft &middot; ' + formatPrice(listing.pricePerMonth) + '/mth &middot; $' + listing.psf + ' PSF &middot; ' + escapeHtml(listing.mrt) + ' &middot; ' + escapeHtml(listing.status) + '</div>' +
            (listing.comments ? '<div class="card-comments">' + escapeHtml(listing.comments) + '</div>' : '') +
          '</div></div>'
        );
      }

      function applyFilterAndSort() {
        var visible = visibleListings();
        var statusFilter = document.getElementById('filter-status').value;
        var sortBy = document.getElementById('sort-by').value;
        var filtered = statusFilter
          ? visible.filter(function (l) { return l.status === statusFilter; })
          : visible.slice();

        if (sortBy === 'price-asc') filtered.sort(function (a, b) { return a.pricePerMonth - b.pricePerMonth; });
        else if (sortBy === 'price-desc') filtered.sort(function (a, b) { return b.pricePerMonth - a.pricePerMonth; });
        else if (sortBy === 'psf-asc') filtered.sort(function (a, b) { return a.psf - b.psf; });
        else if (sortBy === 'psf-desc') filtered.sort(function (a, b) { return b.psf - a.psf; });
        else if (sortBy === 'address') filtered.sort(function (a, b) { return (a.address || '').localeCompare(b.address || ''); });

        return filtered;
      }

      function syncMarkersAndList() {
        var filtered = applyFilterAndSort();
        var listEl = document.getElementById('list');
        listEl.innerHTML = filtered.map(function (listing) {
          var idx = listings.indexOf(listing);
          return renderCard(listing, idx);
        }).join('');

        markers.forEach(function (m) { map.removeLayer(m); });
        markers = [];
        filtered.forEach(function (listing) {
          var marker = L.marker([listing.lat, listing.lng])
            .addTo(map)
            .bindPopup(popupHtml(listing));
          marker._listingIndex = listings.indexOf(listing);
          markers.push(marker);
        });

        listEl.querySelectorAll('.card').forEach(function (card) {
          card.addEventListener('click', function (e) {
            if (e.target.classList.contains('card-remove')) return;
            var idx = parseInt(card.getAttribute('data-index'), 10);
            var listing = listings[idx];
            if (!listing) return;
            map.setView([listing.lat, listing.lng], 17);
            var m = markers.find(function (mk) { return mk._listingIndex === idx; });
            if (m) m.openPopup();
            listEl.querySelectorAll('.card').forEach(function (c) { c.classList.remove('active'); });
            card.classList.add('active');
          });
        });
        listEl.querySelectorAll('.card-remove').forEach(function (btn) {
          btn.addEventListener('click', function (e) {
            e.stopPropagation();
            var id = btn.getAttribute('data-listing-id');
            if (id) { setHidden(id); syncMarkersAndList(); }
          });
        });
      }

      document.getElementById('filter-status').addEventListener('change', syncMarkersAndList);
      document.getElementById('sort-by').addEventListener('change', syncMarkersAndList);

      document.getElementById('load-csv-btn').addEventListener('click', function () {
        var url = document.getElementById('csv-url').value.trim();
        if (url) loadFromUrl(url);
      });
      document.getElementById('csv-file').addEventListener('change', function () {
        var file = this.files[0];
        if (file) { loadFromFile(file); this.value = ''; }
      });
      document.getElementById('restore-removed-btn').addEventListener('click', function () {
        clearHidden();
        syncMarkersAndList();
      });
      document.getElementById('download-json-btn').addEventListener('click', function () {
        var visible = visibleListings();
        var blob = new Blob([JSON.stringify(visible, null, 2)], { type: 'application/json' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'listings.json';
        a.click();
        URL.revokeObjectURL(a.href);
      });

      loadData().then(function (data) {
        listings = data;
        syncMarkersAndList();
      });
    })();
  </script>
</body>
</html>
